---
layout: post
title: "Ad hoc Arbitraries with FsCheck.Xunit"
description: "When using FsCheck with xUnit.net, you can define ad hoc Arbitraries in-line in your test functions."
date: 2015-09-08 11:11 UTC
tags: [Unit Testing, xUnit.net, F#, FsCheck]
---
{% include JB/setup %}

<div id="post">
  <p>
    <em>{{ page.description }}</em>
  </p>
  <p>
    Writing properties with <a href="http://fscheck.github.io/FsCheck">FsCheck</a> and using <a href="https://xunit.net">xUnit.net</a> as a test host is a nice combination. Properties are written as normal functions annotated with the Property attribute:
  </p>
  <p>
    <pre>[&lt;<span style="color:#2b91af;">Property</span>&gt;]
<span style="color:blue;">let</span>&nbsp;``findNeighbors&nbsp;returns&nbsp;8&nbsp;cells``&nbsp;(cell&nbsp;:&nbsp;<span style="color:#2b91af;">int</span>&nbsp;*&nbsp;<span style="color:#2b91af;">int</span>)&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;actual&nbsp;:&nbsp;<span style="color:#2b91af;">Set</span>&lt;<span style="color:#2b91af;">int</span>&nbsp;*&nbsp;<span style="color:#2b91af;">int</span>&gt;&nbsp;=&nbsp;findNeighbors&nbsp;cell
&nbsp;&nbsp;&nbsp;&nbsp;8&nbsp;=!&nbsp;actual.Count</pre>
  </p>
  <p>
    FsCheck takes care of generating values for the <code>cell</code> argument. This works well in many cases, but sometimes you need a bit more control over the range of values being generated by FsCheck.
  </p>
  <h3 id="0f2527f536a54c619263f0fbd7fe8069">
    Motivating example <a href="#0f2527f536a54c619263f0fbd7fe8069" title="permalink">#</a>
  </h3>
  <p>
    You may already have guessed it from the above code snippet, but the example for this article is a property-based approach to <a href="https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life">Conway's Game of Life</a>. One of the properties of the game is that <em>any live cell with more than three live neighbours dies</em>.
  </p>
  <p>
    This means that you have to write a property where one of the values is the number of live neighbours. That number must be a (randomly generated) number between 4 and 8 (including both ends), because the maximum number of neighbours in a cell grid is eight. How do you get FsCheck to give you a number between 4 and 8?
  </p>
  <h3 id="603e1ab5c6aa464d9b88b569516d6bfe">
    Crude solution: conditional property <a href="#603e1ab5c6aa464d9b88b569516d6bfe" title="permalink">#</a>
  </h3>
  <p>
    There are various solutions to the problem of getting fine control over certain values generated by FsCheck, but the ones I first learned turn out to be problematic.
  </p>
  <p>
    One attempt is to use <em>conditional properties</em>, where you supply a boolean expression, and FsCheck will throw away all properties that fail the boolean test:
  </p>
  <p>
    <pre>[&lt;<span style="color:#2b91af;">Property</span>&gt;]
<span style="color:blue;">let</span>&nbsp;``Any&nbsp;live&nbsp;cell&nbsp;with&nbsp;more&nbsp;than&nbsp;three&nbsp;live&nbsp;neighbors&nbsp;dies``
&nbsp;&nbsp;&nbsp;&nbsp;(cell&nbsp;:&nbsp;<span style="color:#2b91af;">int</span>&nbsp;*&nbsp;<span style="color:#2b91af;">int</span>)
&nbsp;&nbsp;&nbsp;&nbsp;(neighborCount&nbsp;:&nbsp;<span style="color:#2b91af;">int</span>)&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;(3&nbsp;&lt;&nbsp;neighborCount&nbsp;&amp;&amp;&nbsp;neighborCount&nbsp;&lt;=&nbsp;8)&nbsp;==&gt;&nbsp;<span style="color:blue;">lazy</span>
 
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;neighborCells&nbsp;=&nbsp;findNeighbors&nbsp;cell&nbsp;|&gt;&nbsp;pickRandom&nbsp;neighborCount
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;actual&nbsp;=&nbsp;calculateNextState&nbsp;(cell&nbsp;::&nbsp;neighborCells)&nbsp;cell
&nbsp;&nbsp;&nbsp;&nbsp;Dead&nbsp;=!&nbsp;actual</pre>
  </p>
  <p>
    The <code>==></code> operator is an FsCheck-specific operator that indicates that FsCheck should disregard all properties where the input arguments don't satisfy the boolean condition on the left side. The use of <a href="https://msdn.microsoft.com/en-us/library/dd233247.aspx">lazy</a> ensures that FsCheck will only attempt to evaluate the property when the condition is true.
  </p>
  <p>
    That's simple and tidy, but unfortunately doesn't work. If you attempt to run this property, you'll get a result like this:
  </p>
  <p>
    <pre>Test 'Ploeh.Katas.GameOfLifeProperties.Any live cell with more than three live neighbors dies' failed: 
Arguments exhausted after 34 tests.</pre>
  </p>
  <p>
    The reason is that FsCheck generates random integers for <code>neighborCount</code>, and most of these values (statistically) fall outside of the range 4-8. After a (default) maximum of 1000 attempts, FsCheck gives up, because at that time, it's only managed to find 34 values that satisfy the condition, but it wants to find 100.
  </p>
  <p>
    What a disappointment.
  </p>
  <h3 id="1ec85929fe5b490e8d172a3e03875443">
    Crude solution: custom Arbitrary <a href="#1ec85929fe5b490e8d172a3e03875443" title="permalink">#</a>
  </h3>
  <p>
    Another apparent solution is to define a custom Arbitrary for <a href="http://www.nuget.org/packages/FsCheck.Xunit">FsCheck.Xunit</a>. The mechanism is to define a static class with your custom rule, and register that with the Property attribute. The class must have a static method that returns an Arbitrary&lt;'a&gt;.
  </p>
  <p>
    In this particular example, you'll need to define a custom Arbitrary that only picks random numbers between 4 and 8. That's easy, but there's a catch: if you change the way <code>int</code> values are generated, you're also going to impact the generated <code>cell</code> values, because a cell here is an <code>int * int</code> tuple.
  </p>
  <p>
    Since you only need a <em>small</em> number, you can cheat and customize byte values instead:
  </p>
  <p>
    <pre><span style="color:blue;">type</span>&nbsp;<span style="color:#2b91af;">ByteBetween1and8</span>&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">static</span>&nbsp;<span style="color:blue;">member</span>&nbsp;Byte&nbsp;()&nbsp;=&nbsp;<span style="color:#2b91af;">Gen</span>.elements&nbsp;[1uy&nbsp;..&nbsp;8uy]&nbsp;|&gt;&nbsp;<span style="color:#2b91af;">Arb</span>.fromGen
 
[&lt;<span style="color:#2b91af;">Property</span>(Arbitrary&nbsp;=&nbsp;[|&nbsp;typeof&lt;<span style="color:#2b91af;">ByteBetween1and8</span>&gt;&nbsp;|])&gt;]
<span style="color:blue;">let</span>&nbsp;``Any&nbsp;live&nbsp;cell&nbsp;with&nbsp;more&nbsp;than&nbsp;three&nbsp;live&nbsp;neighbors&nbsp;dies``
&nbsp;&nbsp;&nbsp;&nbsp;(cell&nbsp;:&nbsp;<span style="color:#2b91af;">int</span>&nbsp;*&nbsp;<span style="color:#2b91af;">int</span>)
&nbsp;&nbsp;&nbsp;&nbsp;(neighborCount&nbsp;:&nbsp;<span style="color:#2b91af;">byte</span>)&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;neighborCount&nbsp;&gt;&nbsp;3uy&nbsp;==&gt;&nbsp;<span style="color:blue;">lazy</span>
 
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;neighborCells&nbsp;=&nbsp;findNeighbors&nbsp;cell&nbsp;|&gt;&nbsp;pickRandom&nbsp;(int&nbsp;neighborCount)
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;actual&nbsp;=&nbsp;calculateNextState&nbsp;(cell&nbsp;::&nbsp;neighborCells)&nbsp;cell
&nbsp;&nbsp;&nbsp;&nbsp;Dead&nbsp;=!&nbsp;actual</pre>
  </p>
  <p>
    The ByteBetween1and8 type is a static class with a single static member that returns Arbitrary&lt;byte&gt;. By using the Arbitrary property of the Property attribute (!), you can register this custom Arbitrary with the Property.
  </p>
  <p>
    This 'solution' side-steps the issue by using a substitute data type instead of the desired data type. There are several problems with this:
    <ul>
      <li>You have to convert the byte value back to an integer in order to use it with the System Under Test: <code>int neighborCount</code>.</li>
      <li><code>3uy</code> is less readable than <code>3</code>.</li>
      <li>A newcomer will wonder why <code>neighborCount</code> is a byte instead of an int.</li>
      <li>You can't generalise this solution. It works because F# has more than one number type, but if you need to generate strings, you're out of luck: there's only one (normal) type of string in .NET.</li>
    </ul>
    Next to these issues with using bytes instead of ints, there's the larger problem that it's awkward to have to define an entire new type (ByteBetween1and8) for this purpose. Finally, this mechanism isn't type-safe. ByteBetween1and8 doesn't implement any interface. It doesn't have to, because the Arbitrary property on the Property attribute is just an array of Type instances. They can be any type, and your code will compile, but if one of those Types don't meet the requirements, an exception will be thrown at run-time.
  </p>
  <p>
    This way works, but is hardly elegant or safe.
  </p>
  <h3 id="3ba01a03bc3c453d8b12134a7b433aa2">
    Ad hoc, in-line Arbitraries <a href="#3ba01a03bc3c453d8b12134a7b433aa2" title="permalink">#</a>
  </h3>
  <p>
    There's a safe way to define ad hoc, in-line Arbitraries with FsCheck.Xunit:
  </p>
  <p>
    <pre>[&lt;<span style="color:#2b91af;">Property</span>&gt;]
<span style="color:blue;">let</span>&nbsp;``Any&nbsp;live&nbsp;cell&nbsp;with&nbsp;&gt;&nbsp;3&nbsp;live&nbsp;neighbors&nbsp;dies``&nbsp;(cell&nbsp;:&nbsp;<span style="color:#2b91af;">int</span>&nbsp;*&nbsp;<span style="color:#2b91af;">int</span>)&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;nc&nbsp;=&nbsp;<span style="color:#2b91af;">Gen</span>.elements&nbsp;[4..8]&nbsp;|&gt;&nbsp;<span style="color:#2b91af;">Arb</span>.fromGen
&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#2b91af;">Prop</span>.forAll&nbsp;nc&nbsp;(<span style="color:blue;">fun</span>&nbsp;neighborCount&nbsp;<span style="color:blue;">-&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;liveNeighbors&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cell
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;findNeighbors
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;shuffle
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span style="color:#2b91af;">Seq</span>.take&nbsp;neighborCount
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span style="color:#2b91af;">Seq</span>.toList
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:blue;">let</span>&nbsp;actual&nbsp;:&nbsp;<span style="color:#2b91af;">State</span>&nbsp;=
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;calculateNextState&nbsp;(cell&nbsp;::&nbsp;liveNeighbors&nbsp;|&gt;&nbsp;shuffle&nbsp;|&gt;&nbsp;set)&nbsp;cell
 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dead&nbsp;=!&nbsp;actual)</pre>
  </p>
  <p>
    Using Prop.forAll enables you to execute your property with a custom Arbitrary, but mixed with the 'normally' generated values that the function receives via its arguments. In this example, <code>nc</code> is an Arbitrary&lt;int&gt;. Notice how it's explicitly used to populate the <code>neighborCount</code> value of the property, whereas the <code>cell</code> value arrives via normal means.
  </p>
  <p>
    This is type-safe, because <code>nc</code> is an Arbitrary&lt;int&gt;, which means that <code>neighborCount</code> is statically inferred to be an <code>int</code>.
  </p>
  <p>
    If you need more than a single ad hoc Arbitrary, you can always create Arbitraries for each of them, and then use Gen.map2, Gen.map3, and so on, to turn those individual Arbitraries into a single Arbitrary of a tuple. You can then use that tuple with Prop.forAll.
  </p>
  <h3 id="443fea5d012a4a2fac7ff3660b0cfe32">
    Summary <a href="#443fea5d012a4a2fac7ff3660b0cfe32" title="permalink">#</a>
  </h3>
  <p>
    FsCheck is a well-designed library that you can combine in lots of interesting ways. In this article you learned how to use Prop.forAll to evaluate a property with a mix of normal, arbitrarily generated values, and an ad hoc, in-line Arbitrary.
  </p>
  <p>
    <strong>Addendum 2016-03-01:</strong> You can <a href="/2016/03/01/ad-hoc-arbitraries-now-with-pipes">write such properties slightly better using the backward pipe operator</a>.
  </p>
</div>
