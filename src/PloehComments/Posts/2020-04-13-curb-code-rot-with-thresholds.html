---
layout: post
title: "Curb code rot with thresholds"
description: "Code bases deteriorate unless you actively prevent it. Institute some limits that encourage developers to clean up."
date: 2020-04-13 8:43 UTC
tags: [Productivity, Code]
image: "/content/binary/gradual-increase-of-complexity.png"
image_alt: "Line chart showing increasing complexity as time passes."
---
{% include JB/setup %}

<div id="post">
	<p>
		<em>{{ page.description }}</em>
	</p>
	<p>
		From time to time I manage to draw the ire of people, with articles such as <a href="/2019/11/04/the-80-24-rule">The 80/24 rule</a> or <a href="/2019/12/09/put-cyclomatic-complexity-to-good-use">Put cyclomatic complexity to good use</a>. I can understand why. These articles suggest specific constraints to which people should consider consenting. <em>Don't write code wider than 80 characters. Don't write code with a <a href="https://en.wikipedia.org/wiki/Cyclomatic_complexity">cyclomatic complexity</a> higher than 7</em>.
	</p>
	<p>
		It makes people uncomfortable.
	</p>
	<h3 id="6c5e4b0817f742bf9ecc0a9050ecb7b5">
		Sophistication <a href="#6c5e4b0817f742bf9ecc0a9050ecb7b5" title="permalink">#</a>
	</h3>
	<p>
		I hope that regular readers understand that I'm a more sophisticated thinker than some of my texts may suggest. I deliberately simplify my points.
	</p>
	<p>
		I do this to make the text more readable. I also aspire to present sufficient arguments, and enough context, that a charitable reader will understand that everything I write should be taken as food for thought rather than gospel.
	</p>
	<p>
		Consider a sentence like the above: <em>I deliberately simplify my points</em>. That sentence, in itself, is an example of deliberate simplification. In reality, I don't <em>always</em> simplify my points. Perhaps sometimes I simplify, but it's not <em>deliberate</em>. I could have written: <em>I often deliberately simplify some of my points</em>. Notice the extra <a href="https://en.wikipedia.org/wiki/Hedge_(linguistics)">hedge words</a>. Imagine an entire text written like that. It would be less readable.
	</p>
	<p>
		I could hedge my words when I write articles, but I don't. I believe that a text that states its points as clearly as possible is easier to understand for any careful reader. I also believe that hedging my language will not prevent casual readers from misunderstanding what I had in mind.
	</p>
	<h3 id="a5da32d0580d4a0f8c19069c57c2a335">
		Archetypes <a href="#a5da32d0580d4a0f8c19069c57c2a335" title="permalink">#</a>
	</h3>	
	<p>
		Why do I suggest hard limits on line width, cyclomatic complexity, and so on?
	</p>
	<p>
		In light of the above, realise that the limits I offer are suggestions. A number like 80 characters isn't a hard limit. It's a representation of an idea; a token. The same is true for <a href="https://en.wikipedia.org/wiki/The_Magical_Number_Seven,_Plus_or_Minus_Two">the magic number seven, plus or minus two</a>. That too, represents an idea - the idea that human short-term memory is limited, and that this impacts our ability to read and understand code.
	</p>
	<p>
		The number seven serves as an archetype. It's a proxy for a more complex idea. It's a simplification that, hopefully, makes it easier to follow the plot.
	</p>
	<p>
		<em>Each method should have a maximum cyclomatic complexity of seven.</em> That's easier to understand than <em>each method should have a maximum cyclomatic complexity small enough that it fits within the cognitive limits of the human brain's short-term memory</em>.
	</p>
	<p>
		I've noticed that a subset of the developer population is quite literal-minded. If I declare: <em>don't write code wider than 80 characters</em> they're happy if they agree, and infuriated if they don't.
	</p>
	<p>
		If you've been paying attention, you now understand that this isn't about the number <em>80</em>, or <em>24</em>, or <em>7</em>. It's about instituting useful quantitative guidance. The actual number is less important.
	</p>
	<p>
		I have reasons to prefer those specific values. I've already motivated them in previous articles. I'm not, though, obdurately attached to those particular numbers. I'd rather work with a team that has agreed to a 120-character maximum width than with a team that follows no policy.
	</p>
	<h3 id="8b7d0a456f6f4bdca9ea2814a67144fc">
		How code rots <a href="#8b7d0a456f6f4bdca9ea2814a67144fc" title="permalink">#</a>
	</h3>
	<p>
		No-one deliberately decides to write legacy code. Code bases gradually deteriorate.
	</p>
	<p>
		Here's another deliberate simplification: code gradually becomes more complicated because each change seems small, and no-one pays attention to the overall quality. It doesn't happen overnight, but one day you realise that you've developed a legacy code base. When that happens, it's too late to do anything about it.
	</p>
	<p>
		<img src="/content/binary/gradual-increase-of-complexity.png" alt="Line chart showing increasing complexity as time passes.">
	</p>
	<p>
		At the beginning, a method has low complexity, but as you fix defects and add features, the complexity increases. If you don't pay attention to cyclomatic complexity, you pass <em>7</em> without noticing it. You pass <em>10</em> without noticing it. You pass <em>15</em> and <em>20</em> without noticing it.
	</p>
	<p>
		One day you discover that you have a problem - not because you finally look at a metric, but because the code has now become so complicated that everyone notices. Alas, now it's too late to do anything about it.
	</p>
	<p>
		<a href="https://en.wikipedia.org/wiki/Software_rot">Code rot</a> sets in a little at a time; it works likeÂ <a href="https://en.wikipedia.org/wiki/Boiling_frog">boiling the proverbial frog</a>.
	</p>
	<h3 id="4fd818d9459548a7863f38ebdd6c40f8">
		Thresholds <a href="#4fd818d9459548a7863f38ebdd6c40f8" title="permalink">#</a>
	</h3>
	<p>
		Agreeing on a threshold can help curb code rot. Institute a rule and monitor a metric. For example, you could agree to keep an eye on cyclomatic complexity. If it exceeds <em>7</em>, you reject the change.
	</p>
	<p>
		<img src="/content/binary/development-of-complexity-guarded-by-threshold.png" alt="Line chart showing how complexity is curbed by a threshold of 7.">
	</p>
	<p>
		Such rules work because they can be used to counteract gradual decay. It's not the specific value <em>7</em> that contributes to better <a href="/2019/03/04/code-quality-is-not-software-quality">code quality</a>; it's the automatic activation of a rule based on a threshold. If you decide that the threshold should be <em>10</em> instead, that'll also make a difference.
	</p>
	<p>
		Notice that the above diagram suggests that exceeding the threshold is still possible. Rules are in the way if you must rigidly obey them. Situations arise where breaking a rule is the best response. Once you've responded to the situation, however, find a way to bring the offending code back in line. Once a threshold is exceeded, you don't get any further warnings, and there's a risk that that particular code will gradually decay.
	</p>
	<h3 id="431b3a30bb6448b6b34c06a169b6fefb">
		What you measure is what you get <a href="#431b3a30bb6448b6b34c06a169b6fefb" title="permalink">#</a>
	</h3>
	<p>
		You could automate the process. Imagine running cyclomatic complexity analysis as part of a Continuous Integration build and rejecting changes that exceed a threshold. This is, in a way, a deliberate attempt to hack the management effect where you get what you measure. With emphasis on a metric like cyclomatic complexity, developers will pay attention to it.
	</p>
	<p>
		Be aware, however, of <a href="https://en.wikipedia.org/wiki/Goodhart%27s_law">Goodhart's law</a> and <a href="https://en.wikipedia.org/wiki/Unintended_consequences">the law of unintended consequences</a>. Just as <a href="/2015/11/16/code-coverage-is-a-useless-target-measure">code coverage is a useless target measure</a>, you have to be careful when you institute hard rules.
	</p>
	<p>
		I've had success with introducing threshold rules because they increase awareness. It can help a technical leader shift emphasis to the qualities that he or she wishes to improve. Once the team's mindset has changed, the rule itself becomes redundant.
	</p>
	<p>
		I'm reminded of <a href="https://en.wikipedia.org/wiki/Dreyfus_model_of_skill_acquisition">the Dreyfus model of skill acquisition</a>. Rules make great training wheels. Once you become proficient, the rules are no longer required. They may even be in your way. When that happens, get rid of them.
	</p>
	<h3 id="97ad7bcd44644a05b78c75e82a3c4ad7">
		Conclusion <a href="#97ad7bcd44644a05b78c75e82a3c4ad7" title="permalink">#</a>
	</h3>
	<p>
		Code deteriorates gradually, when you aren't looking. Instituting rules that make you pay attention can combat code rot. Using thresholds to activate your attention can be an effective countermeasure. The specific value of the threshold is less important.
	</p>
	<p>
		In this article, I've mostly used cyclomatic complexity as an example of a metric where a threshold could be useful. Another example is line width; don't exceed 80 characters. Or line height: methods shouldn't exceed 24 lines of code. Those are examples. If you agree that keeping an eye on a metric would be useful, but you disagree with the threshold I suggest, pick a value that suits you better.
	</p>
	<p>
		It's not the specific threshold value that improves your code; paying attention does.
	</p>
</div>